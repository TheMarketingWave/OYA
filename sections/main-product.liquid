{% style %}
  .product-page {
    /* padding: 32px 0; */
    padding-top: 32px;
    background-color: var(--color-brand-brown);
  }

  .product-page__container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
  }

  .product-page__main {
    display: flex;
    gap: 30px;
    margin-bottom: 20px;
  }

  @media (max-width: 800px) {
    .product-page {
      padding-top: 0px;
    }
    .product-page__main {
      flex-direction: column;
    }
  }

  .product-page__main > * {
    flex: 1;
  }

  /* Image Gallery */
  .product-gallery {
    display: flex;
    flex-direction: column;
    gap: 5px;
    max-width: 330px;
  }

  @media (max-width: 800px) {
    .product-gallery {
      max-width: unset;
      width: 100%;
    }
  }

  .product-gallery__main {
    width: 100%;
    aspect-ratio: 3/4;
    overflow: hidden;
    border-radius: 4px;
  }

  .product-gallery__main img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .product-gallery__thumbnails {
    display: flex;
    gap: 4px;
  }

  .product-gallery__thumbnail {
    width: 90px;
    aspect-ratio: 1;
    overflow: hidden;
    border-radius: 4px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: border-color 0.3s ease;
  }

  .product-gallery__thumbnail:hover,
  .product-gallery__thumbnail.active {
    border-color: var(--color-brand-green);
  }

  .product-gallery__thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Product Details */
  .product-details {
    display: flex;
    flex-direction: column;
    gap: 16px;
    color: var(--color-brand-cream);
  }

  .product-details__tags {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .product-details__tag {
    background: var(--color-brand-green);
    color: white;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 12px;
    text-transform: uppercase;
  }

  .product-details__title {
    font-family: 'Playfair Display', serif;
    font-size: 40px;
    font-weight: 600;
  }

  @media (max-width: 800px) {
    .product-details__title {
      font-size: 30px;
    }
  }

  .product-details__scent {
    font-size: 16px;

    font-weight: bold;
  }

  .product-details__description {
    font-size: 16px;
    line-height: 1.6;
    opacity: 0.9;
  }

  .product-details__price-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 0;
    border-top: 1px solid rgba(224, 217, 186, 0.2);
    border-bottom: 1px solid rgba(224, 217, 186, 0.2);
  }

  .product-details__price {
    font-family: 'Playfair Display', serif;
    font-size: 24px;
    font-weight: 600;
  }

  .product-details__weight {
    font-size: 16px;
    border: 1px solid rgba(224, 217, 186, 0.2);
    padding: 8px 10px;
    border-radius: 25px;
  }

  .product-details__weight::before {
    content: '• ';
  }

  .product-details__weight::after {
    content: ' •';
  }

  .product-details__add-to-cart {
    background: var(--color-brand-cream);
    color: var(--color-brand-brown);
    border: none;
    padding: 10px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .product-details__add-to-cart:hover {
    background: var(--color-brand-green);
    color: white;
  }

  .product-accordion-container {
    max-width: 800px;
    margin: 0 auto;
  }

  /* Flower Image at Bottom */
  .product-flower-image {
    display: flex;
    justify-content: center;
    /* margin-top: 40px; */
    position: relative;
  }

  .product-flower-image img {
    aspect-ratio: 1;
    object-fit: cover;
    max-width: 100%;
    height: auto;
  }

  .product-flower-divider {
    height: 2px;
    background: var(--color-brand-cream);
    width: 500px;
    max-width: 90%;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    bottom: 0px;
    z-index: 100;
  }

  @media (max-width: 800px) {
  }
{% endstyle %}

{% comment %} Parse product description table {% endcomment %}
{% assign scent = '' %}
{% assign description = '' %}
{% assign how_to_use = '' %}
{% assign why_it_matters = '' %}
{% assign precautions = '' %}
{% assign sustainability = '' %}
{% assign rituals = '' %}

{% comment %} Extract table content using simple string search {% endcomment %}
{% if product.description contains '<table' %}
  {% comment %} Split by common row patterns and extract data {% endcomment %}
  {% assign content_lines = product.description | split: '</tr>' %}

  {% for line in content_lines %}
    {% if line contains 'Scent' %}
      {% assign scent_parts = line | split: 'Scent' %}
      {% if scent_parts.size > 1 %}
        {% assign scent = scent_parts[1] | strip_html | strip %}
      {% endif %}
    {% endif %}

    {% if line contains 'Description' %}
      {% assign desc_parts = line | split: 'Description' %}
      {% if desc_parts.size > 1 %}
        {% assign description = desc_parts[1] %}
      {% endif %}
    {% endif %}

    {% if line contains 'How to use' %}
      {% assign use_parts = line | split: 'How to use' %}
      {% if use_parts.size > 1 %}
        {% assign how_to_use = use_parts[1] | strip_html | strip %}
      {% endif %}
    {% endif %}

    {% if line contains 'Why It Matters' %}
      {% assign why_parts = line | split: 'Why It Matters' %}
      {% if why_parts.size > 1 %}
        {% assign why_it_matters = why_parts[1] | strip_html | strip %}
      {% endif %}
    {% endif %}

    {% if line contains 'Precautions' %}
      {% assign prec_parts = line | split: 'Precautions' %}
      {% if prec_parts.size > 1 %}
        {% assign precautions = prec_parts[1] | strip_html | strip %}
      {% endif %}
    {% endif %}

    {% if line contains 'Sustainability-sec' %}
      {% assign sust_parts = line | split: 'Sustainability-sec' %}
      {% if sust_parts.size > 1 %}
        {% assign sustainability = sust_parts[1] | strip_html | strip %}
      {% endif %}
    {% endif %}

    {% if line contains 'Suggested Ritual' %}
      {% assign rit_parts = line | split: 'Suggested Ritual' %}
      {% if rit_parts.size > 1 %}
        {% assign rituals = rit_parts[1] | strip_html | strip %}
      {% endif %}
    {% endif %}
  {% endfor %}
{% endif %}

<div class="product-page">
  <div class="product-page__container">
    <!-- Main Product Section -->
    <div class="product-page__main">
      <!-- Image Gallery Column -->
      <div class="product-gallery">
        {% comment %} Filter out images with "flower" in the filename {% endcomment %}
        {% assign filtered_count = 0 %}

        {% for image in product.images %}
          {% assign image_url = image | image_url %}
          {% assign image_filename = image_url | split: '/' | last | downcase %}
          {% unless image_filename contains 'flower' %}
            {% assign filtered_count = filtered_count | plus: 1 %}
          {% endunless %}
        {% endfor %}

        {% if filtered_count > 0 %}
          {% comment %} Find first non-flower image for main display {% endcomment %}
          {% assign main_image = null %}
          {% for image in product.images %}
            {% assign image_url = image | image_url %}
            {% assign image_filename = image_url | split: '/' | last | downcase %}
            {% unless image_filename contains 'flower' %}
              {% unless main_image %}
                {% assign main_image = image %}
              {% endunless %}
            {% endunless %}
          {% endfor %}

          <div class="product-gallery__main">
            <img
              src="{{ main_image | image_url: width: 600 }}"
              alt="{{ main_image.alt | escape }}"
              width="600"
              height="600"
              id="main-product-image"
            >
          </div>

          {% if filtered_count > 1 %}
            <div class="product-gallery__thumbnails">
              {% for image in product.images %}
                {% assign image_url = image | image_url %}
                {% assign image_filename = image_url | split: '/' | last | downcase %}
                {% unless image_filename contains 'flower' %}
                  {% assign is_first = false %}
                  {% if image == main_image %}
                    {% assign is_first = true %}
                  {% endif %}
                  <div
                    class="product-gallery__thumbnail {% if is_first %}active{% endif %}"
                    onclick="changeMainImage('{{ image | image_url: width: 600 }}', this)"
                  >
                    <img
                      src="{{ image | image_url: width: 100 }}"
                      alt="{{ image.alt | escape }}"
                      width="100"
                      height="100"
                    >
                  </div>
                {% endunless %}
              {% endfor %}
            </div>
          {% endif %}
        {% else %}
          <div class="product-gallery__main">
            {{ 'product-1' | placeholder_svg_tag }}
          </div>
        {% endif %}
      </div>

      <!-- Product Details Column -->
      <div class="product-details">
        <!-- Tags -->
        {% if product.tags.size > 0 %}
          <div class="product-details__tags">
            {% for tag in product.tags limit: 3 %}
              <span class="product-details__tag">{{ tag }}</span>
            {% endfor %}
          </div>
        {% endif %}

        <!-- Title -->
        <h1 class="product-details__title">{{ product.title }}</h1>

        <!-- Scent -->
        {% if scent != blank %}
          <div class="product-details__scent">{{ scent }}</div>
        {% endif %}

        <!-- Description -->
        {% if description != blank %}
          <div class="product-details__description">{{ description }}</div>
        {% elsif product.description != blank %}
          <div class="product-details__description">
            {{ product.description | strip_html | truncate: 200 }}
          </div>
        {% endif %}

        <!-- Price & Weight -->
        <div class="product-details__price-section">
          <span class="product-details__price">{{ product.price | money }}</span>
          {% if product.selected_or_first_available_variant.unit_price_measurement %}
            {% assign unit_measurement = product.selected_or_first_available_variant.unit_price_measurement %}
            <span class="product-details__weight">
              {{ unit_measurement.quantity_value -}}
              {{- unit_measurement.quantity_unit }}
            </span>
          {% elsif product.metafields.custom.weight_volume != blank %}
            <span class="product-details__weight">{{ product.metafields.custom.weight_volume }}</span>
          {% elsif product.variants.first.weight > 0 %}
            <span class="product-details__weight">{{ product.variants.first.weight | weight_with_unit }}</span>
          {% endif %}
        </div>

        <!-- Add to Cart -->
        <div class="product-form">
          <input type="hidden" id="variant-id" value="{{ product.selected_or_first_available_variant.id }}">
          <button
            type="button"
            class="product-card__button"
            onclick="addToCartFromCarousel('{{ product.selected_or_first_available_variant.id }}', '{{ product.title | escape }}', this)"
          >
            Add to Cart
          </button>
        </div>
      </div>
    </div>

    <!-- Accordion Section -->
    {% comment %} Build accordion items array {% endcomment %}
    {% assign accordion_items = '' %}

    {% if rituals != blank %}
      {% if accordion_items != blank %}{% assign accordion_items = accordion_items | append: '|' %}{% endif %}
      {% assign accordion_items = accordion_items | append: 'Suggested Ritual::' | append: rituals %}
    {% endif %}

    {% if how_to_use != blank %}
      {% assign accordion_items = accordion_items | append: 'How to Use::' | append: how_to_use %}
    {% endif %}

    {% if why_it_matters != blank %}
      {% if accordion_items != blank %}{% assign accordion_items = accordion_items | append: '|' %}{% endif %}
      {% assign accordion_items = accordion_items | append: 'Why It Matters::' | append: why_it_matters %}
    {% endif %}

    {% if precautions != blank %}
      {% if accordion_items != blank %}{% assign accordion_items = accordion_items | append: '|' %}{% endif %}
      {% assign accordion_items = accordion_items | append: 'Precautions::' | append: precautions %}
    {% endif %}

    {% if sustainability != blank %}
      {% if accordion_items != blank %}{% assign accordion_items = accordion_items | append: '|' %}{% endif %}
      {% assign accordion_items = accordion_items | append: 'Sustainability::' | append: sustainability %}
    {% endif %}

    {% if accordion_items != blank %}
      {% assign items_array = accordion_items | split: '|' %}
      <div class="product-accordion-container">
        {% render 'accordion', items: items_array %}
      </div>
    {% endif %}

    <!-- Flower Image Section -->
    {% comment %} Find and display the flower image {% endcomment %}
    {% assign flower_image = null %}
    {% for image in product.images %}
      {% assign image_url = image | image_url %}
      {% assign image_filename = image_url | split: '/' | last | downcase %}
      {% if image_filename contains 'flower' %}
        {% assign flower_image = image %}
        {% break %}
      {% endif %}
    {% endfor %}

    {% if flower_image %}
      <div class="product-flower-image">
        <img
          src="{{ flower_image | image_url: width: 500 }}"
          alt="{{ flower_image.alt | escape }}"
          width="500"
          height="500"
        >
        <div class="product-flower-divider"></div>
      </div>
    {% else %}
      <div style="height: 100px;"></div>
    {% endif %}
  </div>
</div>

<script>
  function changeMainImage(imageUrl, thumbnail) {
    // Update main image
    document.getElementById('main-product-image').src = imageUrl;

    // Update active thumbnail
    document.querySelectorAll('.product-gallery__thumbnail').forEach((thumb) => {
      thumb.classList.remove('active');
    });
    thumbnail.classList.add('active');
  }

  // AJAX Add to Cart functionality
  document.addEventListener('DOMContentLoaded', function () {
    const addToCartBtn = document.getElementById('add-to-cart-btn');

    if (addToCartBtn) {
      addToCartBtn.addEventListener('click', async function (e) {
        e.preventDefault();

        const variantId = this.dataset.variantId;
        const btnText = this.querySelector('.btn-text');
        const btnLoading = this.querySelector('.btn-loading');

        // Show loading state
        btnText.style.display = 'none';
        btnLoading.style.display = 'inline';
        this.disabled = true;

        try {
          const response = await fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              id: variantId,
              quantity: 1,
            }),
          });

          if (response.ok) {
            const data = await response.json();

            // Trigger cart updated event for sidepanel
            document.dispatchEvent(
              new CustomEvent('cart:updated', {
                detail: {
                  action: 'item_added',
                  variant_id: variantId,
                  product: data,
                },
              })
            );

            // Show success state
            btnText.textContent = 'Added!';
            btnText.style.display = 'inline';
            btnLoading.style.display = 'none';

            // Reset button after 2 seconds
            setTimeout(() => {
              btnText.textContent = 'Add to Cart';
              this.disabled = false;
            }, 2000);
          } else {
            throw new Error('Failed to add item to cart');
          }
        } catch (error) {
          console.error('Error adding to cart:', error);

          // Show error state
          btnText.textContent = 'Error - Try Again';
          btnText.style.display = 'inline';
          btnLoading.style.display = 'none';

          // Reset button after 3 seconds
          setTimeout(() => {
            btnText.textContent = 'Add to Cart';
            this.disabled = false;
          }, 3000);
        }
      });
    }
  });

  // Example: Listen for accordion expand events
  document.addEventListener('accordionExpand', function (e) {
    console.log('Accordion expanded:', e.detail.title);
    // You can add custom logic here, like analytics tracking
  });
</script>

{% schema %}
{
  "name": "Product Page",
  "tag": "section",
  "class": "product-page-section",
  "settings": []
}
{% endschema %}
